import os
import Bio
import csv
import glob
import argparse
import subprocess
import numpy as np
import pandas as pd
from Bio import SeqIO
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio.Alphabet import IUPAC
from multiprocessing import Pool


parser = argparse.ArgumentParser()
parser.add_argument("-id",
                    help = "Sample ID")
parser.add_argument("-a",
                    help = "result tsv generated by optitype")
parser.add_argument("-txt",
                    help = "somatic mutation information matrix (txt file)")
parser.add_argument("-fa",
                    help = "fasta file for protein information")
parser.add_argument("-o",
                    help = "please enter your output directory")
parser.add_argument("-netmhcpan",
                    help = "please enter the executable netmhcpan path")
parser.add_argument("-nt", type = int,
                    help = "number of thread will be used")

args = parser.parse_args()

sample_id     = args.id
allele_file   = args.a
AA_form_file  = args.txt
protein_file  = args.fa
save_path     = args.o
netMHCpan     = args.netmhcpan
n             = args.nt

if save_path[-1] != '/':
    save_path = save_path + '/'

os.system('mkdir ' + save_path + 'tmp')
# extract HLA typing information 

alleles = []
with open(allele_file) as csvfile:
    spamreader = csv.reader(csvfile, delimiter='\t')
    for row in spamreader:
        alleles.append(row)
alleles = np.array(alleles)

HLA_types = []
for HLA in alleles[1,1:-2]:
    HLA_types.append(HLA.replace('*',':').split(':'))
for line in HLA_types:
    line[0] ='HLA-' + line[0]


#extract somatic mutation information
protein_data = list(SeqIO.parse(protein_file,'fasta'))
ids = []
for record in protein_data:
    ids.append(record.id)

long_AA_sequence_list = []

with open(AA_form_file) as csvfile2:
    spamreader = csv.reader(csvfile2, delimiter = '\t')
    with open(save_path+'tmp/somatic_mutation_reference.csv', "a") as csvfile1:
        writer = csv.writer(csvfile1, delimiter = ',')

        for row in spamreader:
            AA = np.delete(np.array(row).reshape(1,len(row)), [10,11,12], 1)

            if AA[0,0] == 'Variant_ID':
                colnames = np.hstack((AA[0,:10],
                                    ['Neoepitope','Variant_Start','Variant_End',
                                     'AA_before','AA_after']))
                writer.writerow(colnames)

            else:
                AA_change = []
                a,(b,c,d) = AA[0,:10],AA[0,10:13]
                if '*' not in d:
                    Variant_info = a
                    AA_Ref = b
                    AA_Var = d
                    if "-" in d:
                        if len(b) == 1: 
                            start_position = int(c) - 1
                            end_position   = int(c)
                        else:
                            start_position = int(c.split('-')[0])
                            end_position   = int(c.split('-')[0]) + 1

                    elif len(b) == len(d) == 1:
                        start_position = int(c)
                        end_position   = int(c)

                    elif len(b) == len(d) != 1:
                        start_position = int(c.split('-')[0])
                        end_position   = int(c.split('-')[1])

                    else: 
                        start_position = int(c.split('-')[0])
                        end_position   = int(c.split('-')[0]) + len(d) - 1

                    line = np.hstack((np.array(Variant_info).reshape(1,10),
                                         np.array(AA_Ref).reshape(1,1),
                                         np.array(start_position).reshape(1,1),
                                         np.array(end_position).reshape(1,1),
                                         np.array(AA_Var).reshape(1,1)
                                        ))

                    start    = int(line[0,11]) - 1
                    end      = int(line[0,12]) - 1
                    var_info = line[0,0:10].reshape(1,10)
                    var_id   = var_info[0,0]
                    gap      = end - start

                    long_AA_seq = protein_data[ids.index(var_id)].seq[start - 11:end + 11]
                    long_AA_seq = str(long_AA_seq)
                    long_AA_sequence_list.append(long_AA_seq)

                    for AA_len in range(8,12):
                        p_end = 1
                        for ind in range(AA_len + gap):
                            AA_seq      = protein_data[ids.index(var_id)].seq[end - ind:end + AA_len - ind]
                            AA_sequence = str(AA_seq)
                            AA_info     = var_info
                            AA_id       = str(var_id)
                            if p_end > AA_len:
                                p2           = AA_len
                                position_end = p2
                            else:
                                p2           = p_end
                                position_end = p2
                            if p_end - gap <1 :
                                p1       = 1
                                position = p1
                            else:
                                p1       =p_end - gap
                                position = p1
                            p_end = p_end + 1
                            AA_change = []
                            AA_change.append(line[0,10])
                            AA_change.append(str(AA_seq)[p1 - 1:p2])

                            output_line = np.hstack((np.array(AA_info).reshape(1,10),
                                                     np.array(AA_sequence).reshape(1,1),
                                                     np.array(position).reshape(1,1),
                                                     np.array(position_end).reshape(1,1),
                                                     np.array(AA_change).reshape(1,2)))

                            if int(len(output_line[0,10])) == AA_len:
                                writer.writerow(output_line.reshape(output_line.shape[1],))
                                
records = []
for seq in set(long_AA_sequence_list):
    if seq != '':
        records.append(SeqRecord(Seq(seq, IUPAC.protein)))
fasta_file = save_path + 'tmp/neoantigen_candidates.fasta'
SeqIO.write(records, fasta_file, "fasta")



#netMHCpan for neoantigen binding affinity prediction

def typing(line):
    HLA_type_long  = str(line[0]) + str(line[1]) + ':' + str(line[2])
    HLA_type_short = str(line[0]) + str(line[1]) + str(line[2])

    netMHCpan_argument = []
    a1 = '-f ' + fasta_file
    a2 = '-a ' + HLA_type_long
    a3 = '-l 8,9,10,11'
    a4 = '>' + save_path + 'tmp/' + HLA_type_short + "_netMHCpan.csv"
    netMHCpan_argument.extend((netMHCpan,a1,a2,a3, '-BA', a4))
    os.system(' '.join(netMHCpan_argument))

pool = Pool(n)
pool.map(typing, HLA_types)    
pool.close()


#combine netMHCpan result
typing_files = []
for x in os.listdir(save_path + 'tmp/'):
    if 'netMHCpan' in x: typing_files.append(x)

save_name = save_path + 'tmp/netMHCpan_binding_result.csv'
for raw_path in typing_files:
    HLA_type = raw_path.split('_')[0]
    HLA_type = HLA_type[:5] + '*' + HLA_type[5:7] + ':' + HLA_type[7:]
    raw_data = []
    with open(save_path+'tmp/'+raw_path) as csvfile3:
        spamreader = csv.reader(csvfile3, delimiter = ' ')
        for row in spamreader:
            filtered = []
            for item in row:
                if item != '':
                    filtered.append(item)
            if filtered != [] and len(filtered) > 1:
                if filtered[1].startswith("HLA-"):            
                    seq = [HLA_type,filtered[2],filtered[12],filtered[13]]
                    #save_name = save_path + 'tmp/netMHCpan_binding_result.csv'
                    with open(save_name, "a") as csvfile4:
                        writer = csv.writer(csvfile4, delimiter = ',')
                        writer.writerow(seq)



# Make Master Matrix
binding_result   = pd.read_csv(save_name,
                                header = None,
                                names  = ['HLA_type',
                                'Neoepitope',
                                'netMHCpan_binding_affinity_nM',
                                'netMHCpan_precentail_rank'])
somatic_mutation = pd.read_csv(save_path + 'tmp/somatic_mutation_reference.csv')
master_matrix    = pd.merge(somatic_mutation,binding_result, on = 'Neoepitope')
master_matrix.to_csv(save_path + sample_id + '_somatic_mutation_binding_result.csv', index = False)

#clean up
os.system('rm -r ' + save_path + 'tmp/')

